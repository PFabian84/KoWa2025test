<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPD Havixbeck ‚Äì Wahlkarte (Offline)</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Open Sans Font -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <style>
    html, body, #map { height:100%; margin:0; padding:0; font-family:'Open Sans',sans-serif; }
    #controls { position:absolute; top:10px; left:10px; background:white; padding:8px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.3); z-index:1000; }
    #search-ui {
      position: absolute;
      top: 60px; /* weiter unten, damit auf Smartphones nicht verdeckt */
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 2002; /* h√∂her als popups */
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    #search-ui input { flex:1 1 150px; min-width:100px; padding:4px; }
    #search-ui button { padding:4px 8px; }
    #search-ui #suggestions { position:absolute; top:calc(100% + 4px); left:0; background:white; border:1px solid #ccc; border-radius:4px; max-height:150px; overflow-y:auto; width:100%; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:1001; }
    #search-ui #suggestions div { padding:4px 8px; cursor:pointer; }
    #search-ui #suggestions div:hover { background:#eee; }
    @media (max-width:600px) {
      #search-ui {
        top: 50px; /* etwas h√∂her, um Platz zu lassen */
        left: 5px;
        transform: none;
        width: calc(100% - 10px);
        flex-direction: column;
      }
      #search-ui input, #search-ui button {
        width: 100%;
      }
    }
      #search-ui input, #search-ui button { width:100%; }
    }
    .ballot-icon { font-size:24px; line-height:24px; }
    .station-label { background:white; color:black; font-size:0.8em; padding:2px 4px; border-radius:4px; border:1px solid #ccc; }
    .popup-content { text-align:center; }
    .popup-content img { display:block; margin:0 auto 5px; max-width:80px; border-radius:50%; }
    .popup-content .flip { display:inline-block; transform:scaleX(-1); }
    .district-label { background:rgba(0,0,0,0.5); color:white; font-weight:bold; border:none; font-size:0.9em; padding:2px 4px; }
    /* Ensure popups appear above UI */
    .leaflet-popup { z-index:2001 !important; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <div><label>Wahlbezirke (.geojson): <input type="file" id="geojson-file" accept=".geojson"></label></div>
    <div><label>Wahllokale (.json): <input type="file" id="stations-file" accept=".json"></label></div>
    <div><label>Stra√üenliste (.json): <input type="file" id="streets-file" accept=".json"></label></div>
  </div>
  <div id="search-ui">
    <input id="street-search" placeholder="Stra√üe eingeben..." autocomplete="off" disabled>
    <button id="search-btn" disabled>Suchen</button>
    <button id="reset-btn">Zur√ºcksetzen</button>
    <div id="suggestions"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-pip@latest/leaflet-pip.min.js"></script>
  <script>
    const map = L.map('map').setView([51.97565627013313,7.4134788545201395],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OSM' }).addTo(map);
    const ballotIcon = L.divIcon({ html:'üó≥Ô∏è', className:'ballot-icon', iconSize:[32,32], iconAnchor:[16,32] });

    let bezirkeData, districtLayer, pollingStations = [], streets = [], highlighted;
    let stationLookup = {};
    const stationsLayer = L.layerGroup().addTo(map);

    const geoInput = document.getElementById('geojson-file');
    const stationsInput = document.getElementById('stations-file');
    const streetsInput = document.getElementById('streets-file');
    const input = document.getElementById('street-search');
    const searchBtn = document.getElementById('search-btn');
    const resetBtn = document.getElementById('reset-btn');
    const suggestions = document.getElementById('suggestions');

    function loadFile(inputEl, cb) {
      if (!inputEl.files.length) return;
      const reader = new FileReader();
      reader.onload = e => cb(JSON.parse(e.target.result));
      reader.readAsText(inputEl.files[0]);
    }
    function styleFeature() { return { fillColor:'#E3000F', weight:1, color:'#fff', dashArray:'4 4', fillOpacity:1 }; }

    function showStationsForDistrict(bzName) {
      stationsLayer.clearLayers();
      const loc = stationLookup[bzName];
      if (loc) {
        const marker = L.marker([loc.lat, loc.lon], { icon: ballotIcon, zIndexOffset:1000 }).addTo(stationsLayer);
        marker.bindTooltip(`Wahllokal: ${loc.name}`, { permanent:true, direction:'top', offset:[0,-10], className:'station-label' }).openTooltip();
      }
    }

    function applyHighlight(layer) {
      if (highlighted) districtLayer.resetStyle(highlighted);
      highlighted = layer;
      layer.setStyle({ fillOpacity:0.5, color:'#fff', dashArray:'4 4', weight:3 });
      map.fitBounds(layer.getBounds());
      const bzName = layer.feature.properties.name;
      const info = stationLookup[bzName];
      if (info) {
        const pronoun = info.geschlecht === 'w' ? 'ihren' : 'seinen';
        layer.bindPopup(
          `<div class="popup-content">${info.thumbnail?`<img src="${info.thumbnail}" alt="Kandidat Bild">`:''}` +
          `<strong>Bezirk ${info.bezirk}: ${info.kandidat}</strong><br>` +
          `<a href="${info.url}" target="_blank">` +
          `<span style="color:#E3000F;font-weight:bold;">‚û§‚û§ Informationen zu ${info.vorname} und ${pronoun} Schwerpunkten <span class="flip">‚û§‚û§</span></span></a></div>`
        ).openPopup();
      }
      showStationsForDistrict(bzName);
    }

    geoInput.addEventListener('change', () => loadFile(geoInput, data => {
      bezirkeData = data;
      if (districtLayer) map.removeLayer(districtLayer);
      districtLayer = L.geoJSON(bezirkeData, { style: styleFeature, onEachFeature: (f,l) => l.on('click', () => applyHighlight(l)) }).addTo(map);
    }));

    stationsInput.addEventListener('change', () => loadFile(stationsInput, data => {
      pollingStations = data;
      stationLookup = {};
      pollingStations.forEach(loc => stationLookup[String(loc.bezirk)] = loc);
    }));

    streetsInput.addEventListener('change', () => loadFile(streetsInput, data => {
      streets = data; input.disabled = false; searchBtn.disabled = false;
    }));

    input.addEventListener('input', () => {
      suggestions.innerHTML = '';
      const val = input.value.toLowerCase(); if (!val) return;
      streets.filter(s => s.toLowerCase().includes(val)).slice(0,10).forEach(item => {
        const d = document.createElement('div'); d.textContent = item;
        d.onclick = () => { input.value = item; suggestions.innerHTML = ''; };
        suggestions.appendChild(d);
      });
    });

    searchBtn.addEventListener('click', () => {
      const q = input.value.trim(); if (!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q+', Havixbeck, Deutschland')}`)
        .then(r => r.json()).then(res => {
          if (!res.length) return alert('Stra√üe nicht gefunden.');
          const lat = +res[0].lat, lon = +res[0].lon;
          const results = leafletPip.pointInLayer([lon, lat], districtLayer);
          if (results.length) applyHighlight(results[0]); else alert('Kein Wahlbezirk gefunden');
        }).catch(() => alert('Fehler bei der Suche'));
    });

    resetBtn.addEventListener('click', () => {
      input.value = ''; suggestions.innerHTML = '';
      map.setView([51.97565627013313,7.4134788545201395],13);
      if (highlighted) districtLayer.resetStyle(highlighted);
      stationsLayer.clearLayers();
    });
  </script>
</body>
</html>
